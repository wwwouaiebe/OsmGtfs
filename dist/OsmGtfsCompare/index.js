/**
 * 
 * @source: https://github.com/wwwouaiebe/OsmGtfs
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * OsmGtfs - version 3.1.0
 * Build 00460 - 2025-11-16T12:38:32+0100 
 * Copyright 2024 2025 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";class t{#t;constructor(t){Object.freeze(this),this.#t=t}handleEvent(){this.#t.toggle(!0)}}class e{#t;constructor(t){Object.freeze(this),this.#t=t}handleEvent(){this.#t.onPreferedThemeChange()}}class r{#t;constructor(t){Object.freeze(this),this.#t=t}handleEvent(){this.#t.onStorageChange()}}new class{#e;#r;#s;#o(t){try{const e=window[t],r="__storage_test__";return e.setItem(r,r),e.removeItem(r),!0}catch{return!1}}#a(){this.#e=window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark",this.#s&&(this.#e=localStorage.getItem("preferedTheme")||this.#e),document.body.classList.remove("cyDark"),document.body.classList.remove("cyLight"),document.body.classList.add("dark"===this.#e?"cyDark":"cyLight"),"dark"===this.#e?this.#i():this.#n()}#i(){this.#r.innerText="â˜¼",this.#r.title="Apparence: clair",this.#r.alt="Apparence: clair"}#n(){this.#r.innerText="â˜½",this.#r.title="Apparence: sombre",this.#r.alt="Apparence: sombre"}constructor(){Object.freeze(this),window.matchMedia("(prefers-color-scheme: light)").addEventListener("change",new e(this)),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",new e(this)),this.#s=this.#o("localStorage"),this.#s&&window.addEventListener("storage",new r(this)),this.#r=document.getElementById("cyDarkLight"),this.#r&&this.#r.addEventListener("click",new t(this)),this.#a()}onPreferedThemeChange(){this.#s&&localStorage.removeItem("preferedTheme"),this.#a()}onStorageChange(){const t=localStorage.getItem("preferedTheme");t&&t!==this.#e&&this.toggle(!1)}toggle(t){"dark"===this.#e?(this.#e="light",document.body.classList.remove("cyDark"),document.body.classList.add("cyLight"),this.#n()):(this.#e="dark",document.body.classList.remove("cyLight"),document.body.classList.add("cyDark"),this.#i()),this.#s&&t&&localStorage.setItem("preferedTheme",this.#e)}};const s=new class{#h;#m="";#l="";#d="";get operator(){return this.#h}get network(){return this.#m}get vehicle(){return this.#l}#c;get gtfsType(){return this.#c}get ref(){return this.#d}loadData(){switch(this.#h=document.getElementById("osmOperatorSelect").value,this.#m=document.getElementById("osmNetworkSelect").value,this.#l=document.getElementById("osmVehicleSelect").value,this.#d=document.getElementById("osmRef").value,this.#l){case"tram":this.#c=0;break;case"subway":this.#c=1;break;case"bus":this.#c=3}}constructor(){Object.freeze(this)}};class o{#u;#p;#f;#d;#g=[];#w;#v;#E;#R;#y=[];#M;#h;#k;#O;get name(){return this.#u}get from(){return this.#p}get to(){return this.#f}get ref(){return this.#d}get platforms(){return this.#g}get shapePk(){return this.#w}get startDate(){return this.#v}get endDate(){return this.#E}get nodes(){return this.#R}get ways(){return this.#y}get osmId(){return this.#M}get osmType(){return"relation"}get operator(){return this.#h}get fixme(){return this.#k}get note(){return this.#O}get jsonObject(){const t={name:this.#u,from:this.#p,to:this.#f,ref:this.#d,platforms:[],shapePk:this.#w,startDate:this.#v,endDate:this.#E,nodes:this.#R,ways:this.#y,osmId:this.#M,operator:this.#h,fixme:this.#k,note:this.#O};return this.#g.forEach(e=>t.platforms.push(e)),Object.freeze(t.platforms),Object.freeze(t)}constructor(t){Object.freeze(this),this.#u=t.name,this.#p=t.from,this.#f=t.to,this.#d=t.ref,this.#g=t.platforms,this.#w=t.shapePk,this.#v=t.startDate,this.#E=t.endDate,this.#R=t.nodes,this.#y=t.ways,this.#M=t.osmId,this.#h=t.operator,this.#k=t.fixme,this.#O=t.note}}class a{#u;#P;#d;#b;#T=[];#M;#h;#k;#O;get name(){return this.#u}get description(){return this.#P}get ref(){return this.#d}get type(){return this.#b}get routes(){return this.#T}get osmId(){return this.#M}get osmType(){return"relation"}get operator(){return this.#h}get fixme(){return this.#k}get note(){return this.#O}get jsonObject(){const t={description:this.#P,ref:this.#d,type:this.#b,routes:[],osmId:this.#M,operator:this.#h,fixme:this.#k,note:this.#O,name:this.#u};return this.#T.forEach(e=>{t.routes.push(e.jsonObject)}),Object.freeze(t.routes),Object.freeze(t)}constructor(t){Object.freeze(this),this.#P=t.description,this.#d=t.ref,this.#b=Number.parseInt(t.type),this.#T=[];for(const e of t.routes)this.routes.push(new o(e));this.#M=t.osmId,this.#h=t.operator,this.#k=t.fixme,this.#O=t.note,this.#u=t.name}}class i{#D=[];get routesMaster(){return this.#D}get jsonObject(){const t={routesMaster:[]};return this.#D.forEach(e=>{t.routesMaster.push(e.jsonObject)}),Object.freeze(t.routesMaster),Object.freeze(t)}setJsonRoutesMaster(t,e){this.#D=[];for(const r of t)void 0!==e&&r.type!==e||this.#D.push(new a(r))}setRoutesMaster(t){this.#D=t}constructor(){Object.freeze(this)}}const n=new i;class h{async loadData(t){let e=null;return await fetch(t).then(t=>{if(t.ok)return t.json();console.error(String(t.status)+" "+t.statusText)}).then(t=>{e=t}).catch(t=>{console.error(t)}),e}constructor(){}}const m=new class{#x={};get mySqlDbName(){return this.#x.mySqlDbName}get gtfsDirectory(){return this.#x.gtfsDirectory}get jsonDirectory(){return this.#x.jsonDirectory}get operator(){return this.#x.operator}get osmOperator(){return this.#x.osmOperator}get networks(){return this.#x.networks}async loadData(t){return this.#x=await(new h).loadData(t),!!this.#x&&(this.#x.networks.forEach(t=>Object.freeze(t)),Object.freeze(this.#x.networks),!0)}constructor(){Object.freeze(this)}};class l{#b;get type(){return this.#b}#k;get fixme(){return this.#k}#S;get lat(){return this.#S}#I;get lon(){return this.#I}#u;get name(){return this.#u}#N;get nameOperator(){return this.#N}#m;get network(){return this.#m}#h;get operator(){return this.#h}#L;get gtfsRef(){return this.#L}#j;get osmRefs(){return this.#j}#B;get routeRefs(){return this.#B}#z;get zone(){return this.#z}#M;get osmId(){return this.#M}#A;get osmType(){return this.#A}constructor(t){this.#b=t.type,this.#k=t.fixme,this.#S=t.lat,this.#I=t.lon,this.#u=t.name,this.#N=t.nameOperator,this.#m=t.network,this.#h=t.operator,this.#L=t.gtfsRef,this.#j=t.osmRefs,this.#B=t.routeRefs,this.#z=t.zone,this.#M=t.osmId,this.#A=t.osmType,Object.freeze(this)}}const d=new class{#g=new Map;get platforms(){return this.#g}getPlatform(t){return this.#g.get(t)}loadData(t){this.#g=new Map;const e={};t.forEach(t=>{e.type=t.type,e.lat=t.lat,e.lon=t.lon,e.nameOperator=t.nameOperator,e.network=t.network,e.operator=m.operator,e.zone=t.zone,e.routeRefs={},m.networks.forEach(r=>{const s=t["routeRef_"+r.osmNetwork];s&&(e.routeRefs[r.osmNetwork]=s)}),e.gtfsRef=t.gtfsRef,t.type===s.gtfsType&&this.#g.set(t.gtfsRef,new l(e))}),Object.freeze(this.#g)}constructor(){Object.freeze(this),Object.freeze(this.#g)}};class c{report;constructor(){}getJosmEdit(t,e){if(!t?.osmId||!t?.osmType)return"";let r='<button title="Edit the relation with JOSM\nJOSM must be already opened!" class="josmButton" data-osm-obj-id="'+t.osmId+'" data-osm-obj-type="'+t.osmType+'" ';if(e){let t=1;for(const[s,o]of Object.entries(e))r+="data-tag-"+t+'="'+s+"="+o+'" ',t++}return r+=">JOSM </button>",r}getOsmLink(t){return t?.osmId&&t?.osmType?'<a target="_blank" href="https://www.openstreetmap.org/'+t.osmType+"/"+t.osmId+'"> '+t.osmType+" : "+t.osmId+"</a>":""}add(t,e,r,s){const o=document.createElement(t);o.innerHTML=e+this.getOsmLink(r)+this.getJosmEdit(r,s),this.report.appendChild(o)}open(){for(;this.report.firstChild;)this.report.removeChild(this.report.firstChild)}close(){}}const u=new class extends c{#F={routesMaster:{operator:0,fixme:0,note:0,name:0,description:0,members:0,refs:0,sameRefs:0,errors:0,warnings:0,isUnknown:0,routeNoRouteMaster:0},routes:{operator:0,fixme:0,note:0,holes:0,ways:0,fromToRefName:0,doneNoGtfs:0,doneError:0,doneOk:0,toDo:0,errors:0,warnings:0},platforms:{warnings:0,errors:0,name:0,nameOperator:0,fixme:0,note:0,network:0,operator:0,routeRefs:0,zone:0}};#C(){Object.keys(this.#F.routesMaster).forEach(t=>{this.#F.routesMaster[t]=0}),Object.keys(this.#F.routes).forEach(t=>{this.#F.routes[t]=0}),Object.keys(this.#F.platforms).forEach(t=>{this.#F.platforms[t]=0})}addRouteMasterErrorSameRefs(){this.#F.routesMaster.errors++,this.#F.routesMaster.sameRefs++}addRouteMasterErrorRefs(){this.#F.routesMaster.errors++,this.#F.routesMaster.refs++}addRouteMasterErrorMembers(){this.#F.routesMaster.errors++,this.#F.routesMaster.members++}addRouteMasterErrorName(){this.#F.routesMaster.errors++,this.#F.routesMaster.name++}addRouteMasterErrorDescription(){this.#F.routesMaster.errors++,this.#F.routesMaster.description++}addRouteMasterErrorOperator(){this.#F.routesMaster.errors++,this.#F.routesMaster.operator++}addRouteMasterErrorIsUnknown(){this.#F.routesMaster.errors++,this.#F.routesMaster.isUnknown++}addErrorRouteNoRouteMaster(){this.#F.routesMaster.errors++,this.#F.routesMaster.routeNoRouteMaster++}addRouteMasterWarningFixme(){this.#F.routesMaster.warnings++,this.#F.routesMaster.fixme++}addRouteMasterErrorNote(){this.#F.routesMaster.errors++,this.#F.routesMaster.note++}addRouteErrorOperator(){this.#F.routes.errors++,this.#F.routes.operator++}addRouteWarningFixme(){this.#F.routes.warnings++,this.#F.routes.fixme++}addRouteWarningNote(){this.#F.routes.warnings++,this.#F.routes.note++}addRouteErrorHoles(){this.#F.routes.errors++,this.#F.routes.holes++}addRouteErrorWays(){this.#F.routes.errors++,this.#F.routes.ways++}addRouteDoneNoGtfs(){this.#F.routes.doneNoGtfs++,this.#F.routes.errors++}addRouteErrorFromToRefName(){this.#F.routes.fromToRefName++,this.#F.routes.errors++}addRouteDoneOk(){this.#F.routes.doneOk++}addRouteDoneError(){this.#F.routes.doneError++}addRouteToDo(t){this.#F.routes.toDo+=t||1}addRouteValidationError(){this.#F.routes.validationErrors++}addRouteValidationWarning(){this.#F.routes.validationWarnings++}addPlatformsErrorName(){this.#F.platforms.errors++,this.#F.platforms.name++}addPlatformsErrorNameOperator(){this.#F.platforms.errors++,this.#F.platforms.nameOperator++}addPlatformsWarningFixme(){this.#F.platforms.warnings++,this.#F.platforms.fixme++}addPlatformsWarningNote(){this.#F.platforms.warnings++,this.#F.platforms.note++}addPlatformsErrorNetwork(){this.#F.platforms.errors++,this.#F.platforms.network++}addPlatformsErrorOperator(){this.#F.platforms.errors++,this.#F.platforms.operator++}addPlatformsErrorRouteRefs(){this.#F.platforms.errors++,this.#F.platforms.routeRefs++}addPlatformsErrorZone(){this.#F.platforms.errors++,this.#F.platforms.zone++}constructor(){super(),this.report=document.getElementById("statsPane"),Object.freeze(this),Object.seal(this.#F),Object.seal(this.#F.routesMaster),Object.seal(this.#F.routes),Object.seal(this.#F.platforms)}open(){super.open(),this.#C()}close(){this.add("h1","Stats :"),this.add("h2","Routes master"),this.add("p","Osm routes master with errors on operator tag: "+this.#F.routesMaster.operator),this.add("p","Osm routes master with fixme tag: "+this.#F.routesMaster.fixme),this.add("p","Osm routes master with note tag: "+this.#F.routesMaster.note),this.add("p","Osm routes master with errors on name tag: "+this.#F.routesMaster.name),this.add("p","Osm routes master with errors on description tag: "+this.#F.routesMaster.description),this.add("p","Osm routes master with errors on ref tag: "+this.#F.routesMaster.refs),this.add("p","Osm routes master with ref tags of route <> ref tag: "+this.#F.routesMaster.sameRefs),this.add("p","Osm routes master with errors on members: "+this.#F.routesMaster.members),this.add("p","Osm routes withour route master: "+this.#F.routesMaster.routeNoRouteMaster),this.add("p","Unknown Osm routes masters: "+this.#F.routesMaster.isUnknown),this.add("p","Validation errors on routes master to fix: "+this.#F.routesMaster.errors),this.add("p","Validation warnings on routes master nice to fix: "+this.#F.routesMaster.warnings),this.add("h2","Routes"),this.add("p","Osm routes with holes: "+this.#F.routes.holes),this.add("p","Osm routes with invalid ways: "+this.#F.routes.ways),this.add("p","Osm routes with errors on operator: tags "+this.#F.routes.operator),this.add("p","Osm routes with errors on from, to, ref or name tags: "+this.#F.routes.fromToRefName),this.add("p","Osm routes with fixme: "+this.#F.routes.fixme),this.add("p","Osm routes with note: "+this.#F.routes.note),this.add("p","Osm route relations done and aligned on GTFS files: "+this.#F.routes.doneOk),this.add("p","Osm route relations done but not aligned on GTFS files: "+this.#F.routes.doneError),this.add("p","Osm route relations done but no GTFS data found: "+this.#F.routes.doneNoGtfs),this.add("p","Osm route relations todo: "+this.#F.routes.toDo),this.add("p","Validation errors on routes to fix: "+this.#F.routes.errors),this.add("p","Validation warnings on routes nice to fix: "+this.#F.routes.warnings),this.add("h2","platforms"),this.add("p","Osm platforms with errors on name: "+this.#F.platforms.name),this.add("p","Osm platforms with errors on name:operator: "+m.operator+" :"+this.#F.platforms.nameOperator),this.add("p","Osm platforms with fixme: "+this.#F.platforms.fixme),this.add("p","Osm platforms with errors on operator: "+this.#F.platforms.operator),this.add("p","Osm platforms with errors on network: "+this.#F.platforms.network),this.add("p","Osm platforms with errors on route_ref: "+this.#F.platforms.routeRefs),this.add("p","Osm platforms with errors on zone: "+this.#F.platforms.zone),this.add("p","Validation errors on platforms to fix: "+this.#F.platforms.errors),this.add("p","Validation warnings on platforms nice to fix: "+this.#F.platforms.warnings)}};class p{async loadData(){let t=await(new h).loadData("./dataFiles/json/"+s.operator+"/gtfsData-"+s.network+".json");n.setJsonRoutesMaster(t.routesMasterTree.routesMaster,s.gtfsType),d.loadData(t.platforms);const e=t.startDate;return u.add("h1","GTFS files valid from "+new Date(e).toLocaleDateString("en-BE",{weekday:"long",year:"numeric",month:"long",day:"numeric"})),n.routesMaster.forEach(t=>{t.routes.sort((t,e)=>{const r=d.getPlatform(t.platforms[0]).nameOperator,s=d.getPlatform(e.platforms[0]).nameOperator,o=d.getPlatform(t.platforms.slice(-1)[0]).nameOperator,a=d.getPlatform(e.platforms.slice(-1)[0]).nameOperator,i=r.localeCompare(s),n=o.localeCompare(a);return 0===i?n:i})}),!0}constructor(){Object.freeze(this)}}const f=new i;const g=new class{#W=new Map;get platformsWithMore1ref(){return this.#W}#g=new Map;get platforms(){return this.#g}getPlatform(t){return this.#g.get(t)}#H(t){let e={};return t?.tags?.bus?e.type=3:t?.tags?.tram?e.type=0:t?.tags?.subway&&(e.type=1),e.fixme=t?.tags?.fixme,e.lat=t.lat,e.lon=t.lon,e.name=t?.tags?.name,e.nameOperator=t?.tags["name:operator:"+m.operator],e.network=t?.tags?.network,e.operator=t?.tags?.operator,e.zone=t?.tags["zone:"+m.operator],e.osmId=t.id,e.osmType=t.type,e.routeRefs={},e.osmRefs={},m.networks.forEach(r=>{const s=t?.tags["route_ref:"+r.osmNetwork];s&&(e.routeRefs[r.osmNetwork]=s);const o=t?.tags["ref:"+r.osmNetwork];o&&(e.osmRefs[r.osmNetwork]=o)}),e}loadData(t){this.#g=new Map,this.#W=new Map,t.forEach(t=>{const e=this.#H(t);let r=0,s=null;Object.values(e.osmRefs).forEach(t=>{t.split(";").forEach(t=>{e.gtfsRef=t,s=new l(e),this.#g.set(t,s),r++})}),1<r&&this.#W.set(s.osmId,s)}),Object.freeze(this.#g),Object.freeze(this.#W)}constructor(){}};class w{static compareRouteName(t,e){const r=String(Number.parseInt(t)),s=String(Number.parseInt(e)),o=t.replace(r,""),a=e.replace(s,"");return(r.padStart(5," ")+o).localeCompare(s.padStart(5," ")+a)}}class v{#U=new Map;#G=new Map;#_=new Map;#V=new Map;#J=new Map;#q(){this.#U.clear(),this.#V.clear(),this.#_.clear(),this.#G.clear(),this.#J.clear()}#X(t){let e="";for(const r of m.networks){let s=t?.tags["ref:"+r.osmNetwork];s&&(e+=s+";")}return e.slice(0,-1).split(";")[0]}#Z(){const t=["platform","platform_entry_only","platform_exit_only"],e=[];this.#U.forEach(r=>{const s={description:r?.tags?.description,ref:r?.tags.ref,fixme:r?.tags?.fixme,note:r?.tags?.note,operator:r?.tags?.operator,type:["tram","subway","train","bus"].indexOf(r?.tags?.route_master),routes:[],osmId:r.id,name:r?.tags?.name};r.members.forEach(e=>{const r=this.#G.get(e.ref);if(r){const e={name:r?.tags?.name,from:r?.tags?.from,to:r?.tags?.to,ref:r?.tags?.ref,fixme:r?.tags?.fixme,note:r?.tags?.note,operator:r?.tags?.operator,ways:[],platforms:[],osmId:r.id};r.members.forEach(r=>{""===r.role&&e.ways.push(this.#_.get(r.ref));const s=this.#J.get(r.ref);s&&-1!==t.indexOf(r.role)&&e.platforms.push(this.#X(s))}),s.routes.push(e)}}),s.routes.sort((t,e)=>t.name.localeCompare(e.name)),e.push(s)}),f.setJsonRoutesMaster(e)}#K(t){const e=[],r=[];t.forEach(t=>{switch(t.tags&&Object.freeze(t.tags),t.members&&Object.freeze(t.members),Object.freeze(t),t.type){case"relation":switch(t.tags.type){case"route_master":r.push(t);break;case"route":this.#G.set(t.id,t)}break;case"way":this.#_.set(t.id,t);break;case"node":this.#V.set(t.id,t)}"platform"===t?.tags?.public_transport&&e.push(t)}),e.sort((t,e)=>t?.tags?.name.localeCompare(e?.tags?.name)),e.forEach(t=>{this.#J.set(t.id,t)}),r.sort((t,e)=>w.compareRouteName(t.tags.ref,e.tags.ref)),r.forEach(t=>{this.#U.set(t.id,t)})}async#Q(t){return console.info("Warning: osm dev data are used"),console.info(t),(await(new h).loadData("./dataFiles/devData/devData-"+s.network.toUpperCase()+".json")).elements}async#Y(t){let e=null;return await fetch(t).then(t=>{if(t.ok)return t.json();console.error(String(t.status)+" "+t.statusText)}).then(t=>{e=t.elements}).catch(t=>{console.error(t)}),e}async fetchData(){this.#q();let t='https://lz4.overpass-api.de/api/interpreter?data=[out:json][timeout:40];rel["network"~"'+s.network+'"]["route"="'+s.vehicle+'"]["type"="route"]'+(""===s.ref?"":'["ref"="'+s.ref+'"]')+"->.rou;(.rou <<; - .rou;); >> ->.rm;.rm out;",e=null;e=new URL(window.location).searchParams.get("devData")?await this.#Q(t):await this.#Y(t),e&&(this.#K(e),this.#Z(),g.loadData(this.#J))}constructor(){Object.freeze(this)}}const E=new class extends c{constructor(){super(),this.report=document.getElementById("platformsPane"),Object.freeze(this)}};class R{constructor(){Object.freeze(this)}async handleEvent(t){const e=t.target.dataset.osmObjId,r=t.target.dataset.osmObjType;let s="http://localhost:8111/load_object?new_layer="+(document.getElementById("newJosmLayer").checked?"true":"false");switch(r){case"relation":s+="&relation_members=true&objects=r"+e;break;case"node":s+="&objects=n"+e;break;case"way":s+="&objects=w"+e}if(t.target.dataset["tag-1"]){s+="&addtags=";let e=1;for(;t.target.dataset["tag-"+e];)s+=encodeURI(t.target.dataset["tag-"+e]),e++,t.target.dataset["tag-"+e]&&(s+="%7C")}await fetch(s).then(e=>{console.info(String(e.status)+" "+e.statusText),t.target.classList.add("josmButtonVisited")}).catch(t=>{alert(t+"\n\n Are you sure that JOSM is opened and the remote control activated ?\n\nSee: https://josm.openstreetmap.de/wiki/Help/Preferences/RemoteControl")})}}class y{static get#$(){return.5}static get#tt(){return 5}static get#et(){return 10}static get#rt(){return 31}static get#st(){return 32}static get#ot(){return 63}#at(t){return Math.floor(Math.abs(t)+y.#$)*(0<=t?1:-1)}#it(t,e,r){const s=this.#at(t*r),o=this.#at(e*r);let a=s-o;a<<=1,0>s-o&&(a=~a);let i="";for(;y.#st<=a;)i+=String.fromCharCode((y.#st|a&y.#rt)+y.#ot),a>>=y.#tt;return i+=String.fromCharCode(a+y.#ot),i}#nt;#ht(t){let e=null,r=0,s=0;do{e=t.charCodeAt(this.#nt++)-y.#ot,s|=(e&y.#rt)<<r,r+=y.#tt}while(y.#st<=e);return 1&s?~(s>>1):s>>1}constructor(){Object.freeze(this)}encode(t,e){if(!t.length)return"";const r=e.length,s=Array.from(e,t=>Math.pow(y.#et,t));let o="";for(let e=0;e<r;e++)o+=this.#it(t[0][e],0,s[e]);for(let e=1;e<t.length;e++){const a=t[e],i=t[e-1];for(let t=0;t<r;t++)o+=this.#it(a[t],i[t],s[t])}return o}decode(t,e){const r=e.length;if(!t||0===t.length)return[];this.#nt=0;const s=[],o=Array.from(e,t=>Math.pow(y.#et,t)),a=new Array(r).fill(0);for(;this.#nt<t.length;){const e=new Array(r).fill(0);for(let s=0;s<r;s++)a[s]+=this.#ht(t),e[s]=a[s]/o[s];s.push(e)}return s}}class M{#mt;#lt;#dt;static get#ct(){return"\n"}static get#ut(){return"\n\t"}static get#pt(){return"\n\t\t"}static get#ft(){return"\n\t\t\t"}static get#gt(){return"\n\t\t\t\t"}static get#wt(){return 6}#vt(){this.#dt='<?xml version="1.0"?>'+M.#ct,this.#dt+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}#Et(){this.#dt+=M.#ct+"</gpx>"}#Rt(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}#yt(){this.#lt.platforms.forEach((t,e)=>{const r=d.getPlatform(t);this.#dt+=M.#ut+'<wpt lat="'+r.lat+'" lon="'+r.lon+'">'+M.#pt+"<name>"+String(e+1)+" - "+this.#Rt(r.nameOperator)+" ( "+this.#Rt(r.gtfsRef)+" ) </name>"+M.#ut+"</wpt>"})}#Mt(){this.#dt+=M.#ut+"<trk>",this.#dt+=M.#pt+"<name>"+this.#Rt(this.#mt)+"</name>",this.#dt+=M.#pt+"<trkseg>";(new y).decode(this.#lt.nodes,[M.#wt,M.#wt]).forEach(t=>{this.#dt+=M.#ft+'<trkpt lat="'+t[0]+'" lon="'+t[1]+'">'+M.#ft+"</trkpt>"}),this.#dt+=M.#pt+"</trkseg>",this.#dt+=M.#ut+"</trk>"}#kt(t,e){try{const r=e?window.URL.createObjectURL(new File([t],this.#mt+".gpx",{type:e})):URL.createObjectURL(t),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download",this.#mt+".gpx"),s.click(),window.URL.revokeObjectURL(r)}catch(t){t instanceof Error&&console.error(t)}}buildGpx(t,e){this.#lt=t,this.#mt=e,this.#vt(),this.#yt(),this.#Mt(),this.#Et(),this.#kt(this.#dt,"application/xml")}constructor(){Object.freeze(this)}}class k{#Ot(t){const e=Number.parseInt(t);let r=null;return n.routesMaster.forEach(t=>{t.routes.forEach(t=>{t.shapePk===e&&(r=t)})}),r}constructor(){Object.freeze(this)}handleEvent(t){t.target.classList.add("gpxButtonVisited"),(new M).buildGpx(this.#Ot(t.target.dataset.shapePk),t.target.dataset.fileName)}}class O{constructor(){Object.freeze(this)}handleEvent(t){document.getElementById(t.target.dataset.routeMasterLinkDiv).scrollIntoView({behavior:"smooth",block:"start"})}}const P=new class extends c{#Pt=null;#bt=null;#Tt=null;#Dt=null;#xt=document.getElementById("routesLinks");#St="";constructor(){super(),this.report=document.getElementById("relationsPane"),Object.freeze(this)}close(){const t=document.getElementsByClassName("josmButton");for(let e=0;e<t.length;e++)t[e].addEventListener("click",new R);const e=document.getElementsByClassName("gpxButton");for(let t=0;t<e.length;t++)e[t].addEventListener("click",new k);const r=document.getElementsByClassName("busShortcutAnchor");for(let t=0;t<r.length;t++)r[t].addEventListener("click",new O);document.getElementById("waitAnimation").style.visibility="hidden"}open(){super.open(),this.#xt=document.createElement("div"),this.#xt.id="routesLinks",this.report.appendChild(this.#xt),document.getElementById("waitAnimation").style.visibility="visible",this.report.classList.remove("errorsOnly")}#It(t){if(t){this.#Pt=document.getElementById("osm"+t.osmIid),this.#Tt=document.getElementById("osm"+t.osmIid+"DataDiv");const e=document.createElement("span");e.classList.add("busShortcutAnchor"),e.innerText=t.ref+" ",e.dataset.routeMasterLinkDiv="osm"+t.osmId,this.#xt.appendChild(e)}else this.#Pt=null,this.#bt=null;this.#Pt||(this.#Pt=document.createElement("div"),this.report.appendChild(this.#Pt),this.#Pt.appendChild(this.#Dt),this.#Tt=document.createElement("div"),this.#Pt.appendChild(this.#Tt),t&&(this.#Pt.id="osm"+t.osmId,this.#Tt.id="osm"+t.osmId+"DataDiv")),this.#bt=null}#Nt(t){t?(this.#bt=document.getElementById("osm"+t.osmId),this.#Tt=document.getElementById("osm"+t.osmId+"DataDiv")):this.#bt=null,this.#bt||(this.#bt=document.createElement("div"),this.#Pt.appendChild(this.#bt),this.#bt.appendChild(this.#Dt),this.#Tt=document.createElement("div"),this.#bt.appendChild(this.#Tt),t&&(this.#bt.id="osm"+t.osmId,this.#Tt.id="osm"+t.osmId+"DataDiv"))}#Lt(t,e){return'<button title="download the gpx file" class="gpxButton" data-shape-pk="'+t+'" + data-file-name ="'+e+'" >Download gpx</button>'}#jt(t){const e=new Date(t).toLocaleDateString().split("/");return e[2]+"-"+e[1]+"-"+e[0]}#Bt(t,e){const r=d.getPlatform(e.platforms[0]),o=d.getPlatform(e.platforms.slice(-1)[0]);return s.vehicle.slice(0,1).toUpperCase()+s.vehicle.slice(1)+" "+t.ref+" - from "+r.nameOperator+" ("+r.gtfsRef+") to "+o.nameOperator+" ("+o.gtfsRef+") - "+e.shapePk+" - valid from "+this.#jt(e.startDate)+" - valid to "+this.#jt(e.endDate)}addWarning(t,e,r){this.add(t,e,r),this.#Dt.classList.add("isWarning")}addError(t,e,r){this.add(t,e,r),this.#Dt.classList.add("isError"),this.#Tt&&this.#Tt.classList.add("haveErrors"),this.#bt&&this.#bt.classList.add("haveErrors"),this.#Pt&&this.#Pt.classList.add("haveErrors")}add(t,e,r){switch(this.#Dt=document.createElement(t),t){case"h1":this.#It(r);break;case"h2":this.#Nt(r);break;case"h3":case"p":this.#Tt&&this.#Tt.appendChild(this.#Dt)}this.#Dt.innerHTML=e+this.getOsmLink(r)+this.getJosmEdit(r)}addPartial(t,e,r){this.#St.match(/(ðŸ”µ|ðŸŸ¡|ðŸ”´)(?!(âšª|âš«))/g)?this.addError(t,e,r):this.#St.match(/ðŸŸ£(?!(âšª|âš«))/g)?this.addWarning(t,e,r):this.add(t,e,r)}addGpxRoute(t,e,r){this.#St=r;const s=this.#Bt(t,e);r.match(/(ðŸ”µ|ðŸŸ¡|ðŸ”´)(?!(âšª|âš«))/g)?this.addError("p",r+" "+s+" "+this.#Lt(e.shapePk,s)):r.match(/ðŸŸ£(?!(âšª|âš«))/g)?this.addWarning("p",r+" "+s+" "+this.#Lt(e.shapePk,s)):this.add("p",r+" "+s+" "+this.#Lt(e.shapePk,s))}};class b{#zt;#At;#Ft;#Ct=[];#Wt=[];#Ht={};#Ut(){0!==this.#Wt.length&&(E.add("h2","Platform "+this.#At.name,this.#At,this.#Ht),this.#Wt.forEach(t=>{E.add(t.htmlTag,t.text)}))}#Gt(){const t=this.#Ft.nameOperator.replaceAll("Â´","'").replaceAll("  "," ");if(this.#At.nameOperator){0!==this.#At.nameOperator.replaceAll("Â´","'").localeCompare(t)&&(this.#Wt.push({htmlTag:"p",text:"Invalid name:operator:"+m.operator+" : "+this.#At.nameOperator+": Expected : "+t}),u.addPlatformsErrorNameOperator())}else 0!==this.#At.name.localeCompare(t,"fr",{sensitivity:"base",ignorePunctuation:!0})&&(this.#Wt.push({htmlTag:"p",text:"Invalid name or missing name:operator:"+m.operator+" : "+this.#At.name+" name given by "+m.operator+" : "+t}),u.addPlatformsErrorName())}#_t(){this.#At.fixme&&(this.#Wt.push({htmlTag:"p",text:"A fixme exists for this platform:"+this.#At.fixme}),u.addPlatformsWarningFixme())}#Vt(){if(this.#zt)return void this.#Wt.push({htmlTag:"p",text:"This platform have multiple ref:"+m.operator+"* in osm. Not possible to control the network tag"});let t=!1;const e=this.#Ft.network.split(";"),r=this.#At.network?this.#At.network.split(";"):[],s=[];if(e.forEach(e=>{-1===r.indexOf(e)&&(t=!0)}),r.forEach(r=>{-1===e.indexOf(r)&&(-1===this.#Ct.indexOf(r)?s.push(r):t=!0)}),t){const t=e.concat(s).sort((t,e)=>t.localeCompare(e)).toString().replaceAll(",",";");this.#Wt.push({htmlTag:"p",text:"Invalid network:"+this.#At.network+": Expected : "+t}),u.addPlatformsErrorNetwork(),this.#Ht.network=t}}#Jt(){-1===(this.#At.operator?this.#At.operator.split(";"):[]).indexOf(m.operator)&&(this.#Wt.push({htmlTag:"p",text:"The operator tag ("+this.#At.operator+") dont contains "+m.operator}),u.addPlatformsErrorOperator(),this.#Ht.operator=this.#At.operator?this.#At.operator.split(";").concat([m.operator]).sort((t,e)=>t.localeCompare(e)).toString().replaceAll(",",";"):m.operator)}#qt(){this.#zt?this.#Wt.push({htmlTag:"p",text:"This platform have multiple ref:"+m.operator+"* in osm. Not possible to control the route_ref:"+m.operator+"* tags"}):m.networks.forEach(t=>{this.#Ft.routeRefs[t.osmNetwork]!==this.#At.routeRefs[t.osmNetwork]&&(this.#Wt.push({htmlTag:"p",text:"Invalid route_ref:"+t.osmNetwork+": Expected : "+(this.#Ft.routeRefs[t.osmNetwork]?this.#Ft.routeRefs[t.osmNetwork]:"nothing")+" but found "+(this.#At?.routeRefs[t.osmNetwork]?this.#At.routeRefs[t.osmNetwork]:"nothing")}),u.addPlatformsErrorNetwork(),this.#Ht["route_ref:"+t.osmNetwork]=this.#Ft.routeRefs[t.osmNetwork]?this.#Ft.routeRefs[t.osmNetwork]:"")})}#Xt(){this.#Ft.zone!==this.#At.zone&&(this.#Wt.push({htmlTag:"p",text:"Invalid zone:"+m.operator+" Expected : "+this.#Ft.zone+" but found "+(this.#At?.zone?this.#At.zone:"nothing")}),u.addPlatformsErrorZone(),this.#Ht["zone:"+m.osmOperator]=this.#Ft.zone)}validate(t,e){this.#At=t,this.#Ft=e,this.#zt=g.platformsWithMore1ref.get(this.#At.osmId),this.#Wt=[],this.#Ht={},this.#Gt(),this.#_t(),this.#Vt(),this.#Jt(),this.#qt(),this.#Xt(),this.#Ut()}constructor(){m.networks.forEach(t=>{this.#Ct.push(t.osmNetwork)}),Object.freeze(this)}}class T{#Zt(){E.add("h1","Gtfs platforms not found in the osm data");let t=0;d.platforms.forEach(e=>{g.getPlatform(e.gtfsRef)||(E.add("p",e.gtfsRef+" "+e.nameOperator),t++)}),0===t&&E.add("p","Nothing found")}#Kt(){E.add("h1","Osm platforms not found in the gtfs data");let t=0;g.platforms.forEach(e=>{d.getPlatform(e.gtfsRef)||(E.add("p",e.gtfsRef+" "+e.name,{id:e.osmId,type:e.osmType}),t++)}),0===t&&E.add("p","Nothing found")}#Qt(){const t=m.networks.find(t=>t.osmNetwork===s.network)?.excludeList?.gtfs?.excludedPlatforms;t&&(E.add("h1","Excluded gtfs patforms"),t.forEach(t=>{E.add("p",t.ref+" "+t.name+" "+t.reason)}))}#Yt(){E.add("h1","Osm platforms with more than 1 ref"),g.platformsWithMore1ref.forEach(t=>{let e=t.name+" ";for(const[r,s]of Object.entries(t.osmRefs))e+=r+" : "+s+" ";E.add("p",e,{id:t.osmId,type:t.osmType})})}#$t(){E.add("h1","Platforms validation"),g.platforms.forEach(t=>{const e=d.platforms.get(t.gtfsRef);e&&(new b).validate(t,e)})}compare(){""===s.ref?(this.#Qt(),this.#Zt(),this.#Kt(),this.#Yt(),this.#$t()):E.add("h1","No Platforms comparison and validation when the control is limited to a specific route master")}constructor(){Object.freeze(this)}}class D{#te(t){P.add("h1","Routes without route_master"),0===t.length?P.add("p","Nothing found"):t.forEach(t=>{P.add("p","Error M001: route wihout route_master "+(t.tags.name??"")+P.getOsmLink(t),{osmId:t.id,osmType:t.type}),u.addErrorRouteNoRouteMaster()})}async#Q(t){return console.info("Warning: osm dev data are used"),console.info(t),(await(new h).loadData("./dataFiles/devData/routesMasterDevData-"+s.network.toUpperCase()+".json")).elements}async#Y(t){let e=null;return await fetch(t).then(t=>{if(t.ok)return t.json();console.error(String(t.status)+" "+t.statusText)}).then(t=>{e=t.elements}).catch(t=>{console.error(t)}),e}async fetchData(){const t='https://lz4.overpass-api.de/api/interpreter?data=[out:json][timeout:40];rel["network"="'+s.network+'"]["type"="route"]["route"="'+s.vehicle+'"]->.all;rel["route_master"="'+s.vehicle+'"](br.all);rel["route"="'+s.vehicle+'"](r)->.b;(.all; - .b; );out;';let e=null;e=new URL(window.location).searchParams.get("devData")?await this.#Q(t):await this.#Y(t),this.#te(e)}constructor(){Object.freeze(this)}}class x{#ee;#re=!1;#Gt(){if(this.#ee.name||(P.addError("p","Error M008: no name tag for route_master"),u.addRouteMasterErrorName(),this.#re=!0),this.#ee.name&&this.#ee.ref){const t=s.vehicle.substring(0,1).toUpperCase()+s.vehicle.substring(1);this.#ee.name!==t+" "+this.#ee.ref&&(P.addError("p",'Error M007: invalid name for route_master (expected "'+t+" "+this.#ee.ref+'" but found "'+this.#ee.name+'")'),u.addRouteMasterErrorName(),this.#re=!0)}}#se(){this.#ee.ref||(P.addError("p","Error M005: route_master without ref tag "),u.addRouteMasterErrorRefs(),this.#re=!0)}#oe(){this.#ee.routes.forEach(t=>{this.#ee.ref!==t.ref&&(P.addError("p",'Error M006: ref tag of the route master ("'+this.#ee.ref+'") '+P.getOsmLink(this.#ee)+P.getJosmEdit(this.#ee)+' is not the same than the ref tag of the route ("'+t.ref+'") '+P.getOsmLink(t)+P.getJosmEdit(t)),u.addRouteMasterErrorSameRefs(),this.#re=!0)})}#_t(){const t=this.#ee.fixme;t&&(P.addWarning("p","A fixme exists for this route master:"+t),u.addRouteMasterWarningFixme())}#ae(){const t=this.#ee.note;t&&(P.addError("p","A note exists for this route master:"+t),u.addRouteMasterErrorNote())}#Jt(){const t=this.#ee.operator;t?-1===t.split(";").indexOf(m.osmOperator)&&(P.addError("p",'Error M012: Missing operator ( expected containing "'+m.osmOperator+'" but found "'+this.#ee.operator+'")'),u.addRouteMasterErrorOperator(),this.#re=!0):(P.addError("p",'Error M011: Oprator tag not found (expected to be "'+m.osmOperator+'")'),u.addRouteMasterErrorOperator(),this.#re=!0)}validate(t){this.#ee=t,P.add("h3","Validation of tags for route master"),this.#Jt(),this.#_t(),this.#ae(),this.#se(),this.#oe(),this.#Gt(),this.#re||P.add("p","No validation errors found for route_master")}constructor(){Object.freeze(this)}}class S{#ie=!1;#ne=!1;#lt;#he(t){return t.nodes[0]===t.nodes.toReversed()[0]}#me(t,e){return e.nodes[0]===t.nodes[0]||e.nodes[0]===t.nodes.toReversed()[0]||e.nodes.toReversed()[0]===t.nodes[0]||e.nodes.toReversed()[0]===t.nodes.toReversed()[0]}#le(t,e){return this.#he(t)?-1!==t.nodes.indexOf(e.nodes[0])||-1!==t.nodes.indexOf(e.nodes.toReversed()[0]):!!this.#he(e)&&(-1!==e.nodes.indexOf(t.nodes[0])||-1!==e.nodes.indexOf(t.nodes.toReversed()[0]))}#de(t){"construction"===t?.tags?.highway&&(P.addWarning("p","Warning R017: a road under construction is used as way for the route ",{osmId:t.id,osmType:t.type}),this.#ie=!0),-1===["motorway","motorway_link","trunk","trunk_link","primary","primary_link","secondary","secondary_link","tertiary","tertiary_link","service","residential","unclassified","living_street","busway","construction"].indexOf(t?.tags?.highway)&&"yes"!==t?.tags?.psv&&"yes"!==t?.tags[s.vehicle]&&(P.addError("p","Error R013: an invalid highway is used as way for the route ",{osmId:t?.id,osmType:t?.type}),this.#ie=!0)}#ce(t){"tram"!==t?.tags?.railway&&(P.add("p","Error R014: an invalid railway is used as way for the route ",{osmId:t.id,osmType:t.type}),this.#ie=!0)}#ue(t){"subway"!==t?.tags?.railway&&(P.add("p","Error R014: an invalid railway is used as way for the route ",{osmId:t.id,osmType:t.type}),this.#ie=!0)}#pe(t,e){return!(t&&!this.#me(e,t)&&!this.#le(e,t))||(P.addError("p","Error R001: hole found for route "+P.getOsmLink(this.#lt)+" between way id "+P.getOsmLink({osmId:t.id,osmType:t.type})+" and way id "+P.getOsmLink({osmId:e.id,osmType:e.type})),this.#ne=!0,!1)}validate(){let t=null;return this.#lt.ways.forEach(e=>{switch(this.#pe(t,e)||(t=null),s.vehicle){case"bus":this.#de(e);break;case"tram":this.#ce(e);break;case"subway":this.#ue(e)}t=e}),this.#ne&&u.addRouteErrorHoles(),this.#ie&&u.addRouteErrorWays(),this.#ie||this.#ne}constructor(t){this.#lt=t,Object.freeze(this)}}class I{#re=!1;#lt=null;#fe(){const t=g.getPlatform(this.#lt.platforms[0]);this.#lt.from&&this.#lt.from!==t?.name&&t?.nameOperator&&this.#lt.from.toLowerCase()!==t.nameOperator.toLowerCase()&&(P.addError("p","Error R003: the from tag is not equal to the name of the first platform for route "),this.#re=!0)}#ge(){const t=g.getPlatform(this.#lt.platforms[this.#lt.platforms.length-1]);this.#lt.to&&this.#lt.to!==t?.name&&t?.nameOperator&&this.#lt.to.toLowerCase()!==t.nameOperator.toLowerCase()&&(P.addError("p","Error R005: the to tag is not equal to the name of the last platform for route"),this.#re=!0)}#we(){return this.#lt?.from&&this.#lt?.to&&this.#lt?.name&&this.#lt?.ref}#Gt(){let t=s.vehicle.substring(0,1).toUpperCase()+s.vehicle.substring(1);if(this.#we()){let e=t+" "+this.#lt.ref+": "+this.#lt.from+" â†’ "+this.#lt.to;this.#lt.name.replaceAll("=>","â†’")!==e&&(P.addError("p",'Error R006: Invalid name (expected "'+e+'" but found "'+this.#lt.name+'") for route ',this.#lt),this.#re=!0)}}validate(){return this.#lt.from||(P.addError("p","Error R002: a from tag is not found for route"),this.#re=!0),this.#lt.to||(P.addError("p","Error R004: a to tag is not found for route"),this.#re=!0),this.#lt.ref||(P.addError("p","Error R020: a ref tag is not found for route"),this.#re=!0),this.#lt.name||(P.addError("p","Error R021: a name tag is not found for route"),this.#re=!0),this.#fe(),this.#ge(),this.#Gt(),this.#re&&u.addRouteErrorFromToRefName(),this.#re}constructor(t){this.#lt=t,Object.freeze(this)}}class N{#lt;#re=!1;#_t(){const t=this.#lt.fixme;t&&(P.addWarning("p","Warning R019: A fixme exists for this route:"+t),u.addRouteWarningFixme())}#ae(){const t=this.#lt.note;t&&(P.addWarning("p","Warning R024: A note exists for this route:"+t),u.addRouteWarningNote())}#Jt(){const t=this.#lt.operator;t?-1===t.split(";").indexOf(m.osmOperator)&&(P.addError("p",'Error R023: Missing operator ( expected containing "'+m.osmOperator+'" but found "'+this.#lt.operator+'")'),u.addRouteMasterErrorOperator(),this.#re=!0):(P.addError("p",'Error R022: Oprator tag not found (expected to be "'+m.osmOperator+'")'),u.addRouteErrorOperator(),this.#re=!0)}validate(t){this.#lt=t,P.add("h3","Validation of tags, roles and members for route"),this.#Jt(),this.#_t(),this.#re=new S(this.#lt).validate()||this.#re,this.#re=new I(this.#lt).validate()||this.#re,this.#re||P.add("p","No validation errors found for route")}constructor(){Object.freeze(this)}}class L{static get haveSamePlatforms(){return 3}static get haveSameFromToPlatforms(){return 2}static get haveSimilarFromToPlatforms(){return 1}static get haveDifferentPlatforms(){return 0}}class j{shapePk=0;matchScore=0;constructor(t,e){this.shapePk=t,this.matchScore=e,Object.freeze(this)}}class B{#ve=[];#M;get osmId(){return this.#M}filter(t){return this.#ve.filter(e=>t===e.matchScore)}freeze(){Object.freeze(this.#ve)}addMatchScore(t){this.#ve.push(t)}constructor(t){this.#M=t,Object.freeze(this)}}class z{#Ee={};#Re=new Map;get matchedGtfsRoutes(){return this.#Re}#ye(t,e){if(t===e)return!0;const r=g.getPlatform(t)?.osmId,s=g.getPlatform(e)?.osmId;return r&&s&&r===s}#Me(t,e){let r=t.platforms.toString()===e.platforms.toString();if(!r&&t.platforms.length===e.platforms.length){r=!0;for(let s=0;s<t.platforms.length;s++)r=r&&this.#ye(t.platforms[s],e.platforms[s])}return r}#ke(t,e){return this.#ye(t.platforms[0],e.platforms[0])&&this.#ye(t.platforms[t.platforms.length-1],e.platforms[e.platforms.length-1])}#Oe(t,e){return t.substring(t.length-1,0)===e.substring(e.length-1,0)}#Pe(t,e){return this.#Oe(t.platforms[0],e.platforms[0])&&this.#Oe(t.platforms[t.platforms.length-1],e.platforms[e.platforms.length-1])}#be(t,e){return this.#Me(t,e)?(this.#Re.set(e.shapePk,e.shapePk),L.haveSamePlatforms):this.#ke(t,e)?(this.#Re.set(e.shapePk,e.shapePk),L.haveSameFromToPlatforms):this.#Pe(t,e)?(this.#Re.set(e.shapePk,e.shapePk),L.haveSimilarFromToPlatforms):L.haveDifferentPlatforms}getMatchScoresSamePlatforms(t){return this.#Ee[t.osmId].filter(L.haveSamePlatforms)}getMatchScoresSameFromEndPlatforms(t){return this.#Ee[t.osmId].filter(L.haveSameFromToPlatforms)}getMatchScoresSimilarFromEndPlatforms(t){return this.#Ee[t.osmId].filter(L.haveSimilarFromToPlatforms)}build(t,e){e.routes.forEach(e=>{const r=new B(e.osmId);t.routes.forEach(t=>{r.addMatchScore(new j(t.shapePk,this.#be(e,t)))}),r.freeze(),this.#Ee[e.osmId]=r}),Object.freeze(this.#Ee),Object.freeze(this.#Re)}}class A{#Te;#De;#Ee;#xe=new Map;#Se(t){let e=[];const r=g.getPlatform(t)?.osmRefs;return r&&Object.values(r).forEach(t=>{e=e.concat(t.split(";"))}),e}#Ie(t,e){const r=[],s=[];t.platforms.forEach(t=>{let s=!1;this.#Se(t).forEach(t=>{s||=e.platforms.includes(t)}),s||r.push(t)}),e.platforms.forEach(e=>{let r=!1;this.#Se(e).forEach(e=>{r||=t.platforms.includes(e)}),r||s.push(e)});let o="Osm platforms to remove: ";r.forEach(t=>{o+=(g.getPlatform(t)?.name??"???")+" ("+t+"),"});let a="gtfs platforms to add: ";s.forEach(t=>{a+=(d.getPlatform(t)?.nameOperator??"???")+" ("+t+"),"}),P.addPartial("p",a),P.addPartial("p",o),0===r.length&&0===s.length&&P.addPartial("p","Verify the order of the platforms and the duplicate platforms")}#Ne(t,e){let r="ðŸ”´";return e.matchScore===L.haveSamePlatforms?r="ðŸŸ¢":e.matchScore===L.haveSameFromToPlatforms?r="ðŸ”µ":e.matchScore===L.haveSimilarFromToPlatforms&&(r="ðŸŸ¡"),new Date(t.startDate).valueOf()>Date.now()?r+="âšª":new Date(t.endDate).valueOf()<Date.now()&&(r+="âš«"),r}#Le(t,e){t.forEach(t=>{const r=this.#Te.routes.find(e=>e.shapePk===t.shapePk);P.addGpxRoute(this.#Te,r,this.#Ne(r,t)),e&&this.#Ie(e,this.#Te.routes.find(e=>e.shapePk===t.shapePk)),this.#xe.set(r.shapePk,r.shapePk)})}#je(t){P.add("h3","GTFS comparison results for route: "+(1===t.length?"a gtfs route with all platforms found":"multiple gtfs routes with all platforms found")),this.#Le(t),u.addRouteDoneOk()}#Be(t,e){P.add("h3","GTFS comparison results for route: "+(1===t.length?"a gtfs route with from and to platforms found":"multiple gtfs routes with from and to platforms found")),this.#Le(t,e),u.addRouteDoneError()}#ze(t,e){P.add("h3","GTFS comparison results for route: "+(1===t.length?"a gtfs route with similar from and to platforms found":"multiple gtfs routes with similar from and to platforms found")),this.#Le(t,e),u.addRouteDoneError()}#Ae(){this.#xe.clear(),this.#De.routes.forEach(t=>{P.add("h2","Route : "+t.name,t),(new N).validate(t);const e=this.#Ee.getMatchScoresSamePlatforms(t),r=this.#Ee.getMatchScoresSameFromEndPlatforms(t),s=this.#Ee.getMatchScoresSimilarFromEndPlatforms(t);0!==e.length?this.#je(e):0!==r.length?this.#Be(r,t):0===s.length?(P.add("h3","GTFS comparison results for route"),P.addError("p","ðŸ”´ No gtfs route found"),u.addRouteDoneNoGtfs()):this.#ze(s,t)})}#Fe(){return(this.#De.description??"").toLowerCase().replaceAll(" ","")!==(this.#Te.description??"").toLowerCase().replaceAll(" ","")?(P.addError("p",'Error M009: the osm description of the route_master is not equal to the GTFS route long name (expected "'+this.#Te.description+'" but found "'+this.#De.description+'")'),u.addRouteMasterErrorDescription(),!1):(P.add("p","No validation errors found for route_master"),!0)}#Ce(){this.#xe.size!==this.#Te.routes.length&&(P.add("h2","gtfs routes not found in the osm data"),this.#Te.routes.forEach(t=>{if(!this.#xe.get(t.shapePk)){const e=[];this.#De.routes.forEach(r=>{r.platforms.toString().match(t.platforms.toString())&&e.push([t,r])});let r=0===e.length?"ðŸ”´":"ðŸŸ£";new Date(t.startDate).valueOf()>Date.now()?r+="âšª":new Date(t.endDate).valueOf()<Date.now()&&(r+="âš«"),P.addGpxRoute(this.#Te,t,r),e.forEach(t=>{P.addPartial("p","This route is a part of "+t[1].name,t[1])})}}))}compare(t,e){this.#Te=t,this.#De=e,this.#Ee=new z,this.#Ee.build(this.#Te,e),P.add("h3","GTFS comparison results for route_master"),this.#Fe(),this.#Ae(),this.#Ce()}constructor(){}}class F{#We=[];#He=[];#Ue(t,e,r){let s=null,o=t.routesMaster.filter(t=>e.ref===t.ref);switch(o.length){case 0:r.push(e);break;case 1:s=o[0];break;default:o=t.routesMaster.filter(t=>e.ref===t.ref&&t.description&&e.description&&0===e.description.toLowerCase().localeCompare(t.description.toLowerCase())),1===o.length?s=o[0]:r.push(e)}return s}#Ge(){n.routesMaster.forEach(t=>{const e=this.#Ue(f,t,this.#We);e&&(P.add("h1","Route master : "+s.vehicle.slice(0,1).toUpperCase()+s.vehicle.slice(1)+" "+(e.ref??"")+" "+(e.description??"")+" ",e),(new x).validate(e),(new A).compare(t,e))})}#_e(){f.routesMaster.forEach(t=>{this.#Ue(n,t,this.#He)})}#Ve(){P.add("h1","gtfs routes master without osm routes master"),0===this.#We.length?P.add("p","nothing found"):this.#We.forEach(t=>{P.add("h2","gtfs route : "+s.vehicle.slice(0,1).toUpperCase()+s.vehicle.slice(1)+" "+t.ref+" "+t.description),t.routes.forEach(e=>{P.addGpxRoute(t,e,"ðŸ”´"),u.addRouteToDo()})})}#Je(){P.add("h1","Osm routes master not found in the gtfs data"),0===this.#He.length?P.add("p","nothing found"):this.#He.forEach(t=>{P.addError("p","Error M10: An unknown osm route master is found: "+(t.ref??"")+" "+(t.description??""),t),u.addRouteMasterErrorIsUnknown()})}compare(){this.#Ge(),this.#_e(),s.ref||(this.#Ve(),this.#Je())}constructor(){Object.freeze(this)}}const C=new class{#qe=[];#Xe=-1;constructor(){Object.freeze(this)}reset(){let t=document.getElementsByTagName("p");for(this.#Xe=0,this.#qe.length=0;this.#Xe<t.length;)t.item(this.#Xe).innerText.match(/(ðŸ”µ|ðŸŸ¡|ðŸ”´|ðŸŸ£)/g)&&this.#qe.push(t.item(this.#Xe)),this.#Xe++;this.#Xe=-1}next(){0!==this.#qe.length&&(-1<this.#Xe&&this.#qe[this.#Xe].classList.remove("currentError"),this.#Xe++,this.#Xe===this.#qe.length&&(this.#Xe=0),this.#qe[this.#Xe].classList.add("currentError"),this.#qe[this.#Xe].scrollIntoView({behavior:"smooth",block:"start"}))}previous(){0!==this.#qe.length&&(-1<this.#Xe&&this.#qe[this.#Xe].classList.remove("currentError"),this.#Xe--,0>this.#Xe&&(this.#Xe=this.#qe.length-1),this.#qe[this.#Xe].classList.add("currentError"),this.#qe[this.#Xe].scrollIntoView({behavior:"smooth",block:"start"}))}};class W{constructor(){Object.freeze(this)}async start(){document.getElementById("errorsOnlyInput").value="Errors only",s.loadData(),E.open(),P.open(),u.open(),await(new p).loadData(),await(new v).fetchData(),await(new D).fetchData(),(new F).compare(),(new T).compare(),E.close(),P.close(),u.close(),C.reset()}}class H{constructor(){Object.freeze(this)}async handleEvent(){await(new W).start()}}class U{constructor(){Object.freeze(this)}async handleEvent(t){const e=t.target.value;await m.loadData("./dataFiles/operators/"+e+".json");const r=Array.from(m.networks,t=>t.osmNetwork).sort((t,e)=>t.localeCompare(e)),s=document.getElementById("osmNetworkSelect");s.options.length=0,r.forEach(t=>{const e=document.createElement("option");e.text=t,s.options.add(e)})}}class G{#h=null;#m=null;#l=null;#Ze=null;#Ke(){const t=new URL(window.location);this.#h=t.searchParams.get("operator")||"TEC",this.#m=t.searchParams.get("network")||"TECL",this.#l=t.searchParams.get("vehicle")||"bus",this.#Ze=t.searchParams.get("autostartup"),this.#h=this.#h.toUpperCase(),this.#m=this.#m.toUpperCase(),this.#l=this.#l.toLowerCase()}async#Jt(){return!!await m.loadData("./dataFiles/operators/"+this.#h+".json")||(alert("Unknown operator parameter "+this.#h),!1)}#Vt(){return this.#m?!!m.networks.find(t=>this.#m===t.osmNetwork)||(alert("Unknown network parameter: "+this.#m),!1):(null!==this.#Ze&&alert('Autostartup is enabled but the "network" url parameter is not present'),!1)}#Qe(){return this.#l?-1!==["bus","tram","subway"].indexOf(this.#l)||(alert('bad value for vehicle parameter : "'+this.#l+'". Must be "bus", "tram" or "subway"'),!1):(null!==this.#Ze&&alert('Autostartup is enabled but the "vehicle" url parameter is not present'),!1)}#Ye(){const t=document.getElementById("osmNetworkSelect");m.networks.forEach(e=>{const r=document.createElement("option");r.text=e.osmNetwork,t.appendChild(r)})}#$e(){document.getElementById("osmNetworkSelect").value=this.#m}#tr(){document.getElementById("osmVehicleSelect").value=this.#l}async start(){this.#Ke(),await this.#Jt()&&(this.#Ye(),this.#Vt()&&this.#$e(),this.#Qe()&&(this.#tr(),null!==this.#Ze&&(new W).start()))}constructor(){Object.freeze(this)}}class _{constructor(){Object.freeze(this)}handleEvent(t){t.target.value="All"===t.target.value?"Error only":"All",document.getElementById("relationsPane").classList.toggle("errorsOnly")}}class V{#er;static#rr=[];#sr;static#or=[];constructor(t,e){this.#er=t,this.#sr=e,V.#rr.push(t),V.#or.push(e),Object.freeze(this)}handleEvent(){V.#rr.forEach(t=>document.getElementById(t).classList.remove("selectedPaneButton")),document.getElementById(this.#er).classList.add("selectedPaneButton"),V.#or.forEach(t=>document.getElementById(t).classList.add("hiddenPane")),document.getElementById(this.#sr).classList.remove("hiddenPane"),"relationsButton"===this.#er?document.getElementById("routesLinks").classList.remove("hiddenPane"):document.getElementById("routesLinks").classList.add("hiddenPane")}}class J{constructor(){Object.freeze(this)}handleEvent(){C.previous()}}class q{constructor(){Object.freeze(this)}handleEvent(){C.next()}}(new class{constructor(){Object.freeze(this)}start(){document.getElementById("osmOperatorSelect").addEventListener("change",new U,!1),document.getElementById("goInput").addEventListener("click",new H,!1),document.getElementById("errorsOnlyInput").addEventListener("click",new _,!1),document.getElementById("previousError").addEventListener("click",new J,!1),document.getElementById("nextError").addEventListener("click",new q,!1),document.getElementById("relationsButton").addEventListener("click",new V("relationsButton","relationsPane"),!1),document.getElementById("platformsButton").addEventListener("click",new V("platformsButton","platformsPane"),!1),document.getElementById("statsButton").addEventListener("click",new V("statsButton","statsPane"),!1),document.getElementById("version").innerText="Version: v3.1.0",(new G).start()}}).start()}();